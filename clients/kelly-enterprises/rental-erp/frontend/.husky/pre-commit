#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Run ESLint to catch architectural violations
echo "ğŸ“‹ Checking code architecture compliance..."
npx eslint src/ --ext .ts,.tsx --max-warnings 0 || {
  echo "âŒ ESLint found architectural violations!"
  echo "ğŸ’¡ Common fixes:"
  echo "   - Use infrastructure Modal instead of custom modal implementations"
  echo "   - Replace hardcoded colors with CSS custom properties"
  echo "   - Import infrastructure components instead of creating custom ones"
  exit 1
}

# Check for common anti-patterns
echo "ğŸ—ï¸  Scanning for architectural anti-patterns..."

# Check for custom modal patterns in new/modified files
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | xargs grep -l "modalOverlay\|modal-overlay\|backdrop.*fixed\|position.*fixed.*z-index" && {
  echo "âŒ Custom modal implementation detected!"
  echo "ğŸ’¡ Use the infrastructure Modal component instead"
  echo "   import { Modal } from '../infrastructure/components'"
  exit 1
} || true

# Check for hardcoded z-index values outside infrastructure
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(css|scss|ts|tsx)$' | grep -v 'infrastructure/' | xargs grep -l "z-index.*[0-9]" && {
  echo "âš ï¸  Hardcoded z-index detected outside infrastructure!"
  echo "ğŸ’¡ Use CSS custom properties for z-index values"
  echo "   z-index: var(--z-modal);"
  exit 1
} || true

# Check for duplicate button implementations
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' | xargs grep -l "className.*button\|styled.*button" | grep -v 'infrastructure/' && {
  echo "âš ï¸  Custom button implementation detected!"
  echo "ğŸ’¡ Use the infrastructure Button component instead"
  echo "   import { Button } from '../infrastructure/components'"
  exit 1
} || true

echo "âœ… Architecture compliance checks passed!"

# Type checking
echo "ğŸ”§ Running TypeScript type check..."
npx tsc --noEmit || {
  echo "âŒ TypeScript compilation errors found!"
  exit 1
}

echo "âœ… Pre-commit checks completed successfully!"