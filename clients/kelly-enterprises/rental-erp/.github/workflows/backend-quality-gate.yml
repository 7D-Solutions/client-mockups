name: Backend Quality Gate

on:
  push:
    branches: [ main, development-core ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-quality-gate.yml'
  pull_request:
    branches: [ main, development-core ]
    paths:
      - 'backend/**'

env:
  NODE_VERSION: '18'

jobs:
  quality-gate:
    name: Backend Quality Gate
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: fireproof_root_sandbox
          MYSQL_DATABASE: fai_db_sandbox
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install Dependencies
      run: |
        cd backend
        npm ci

    - name: Create Required Directories
      run: |
        cd backend
        mkdir -p logs
        mkdir -p reports/sprint4/post
        touch logs/audit.log
        touch logs/error.log

    - name: Setup Environment
      run: |
        cd backend
        echo "NODE_ENV=test" > .env
        echo "DATABASE_HOST=localhost" >> .env
        echo "DATABASE_PORT=3307" >> .env
        echo "DATABASE_USER=root" >> .env
        echo "DATABASE_PASSWORD=fireproof_root_sandbox" >> .env
        echo "DATABASE_NAME=fai_db_sandbox" >> .env
        echo "JWT_SECRET=test-secret-key-for-ci" >> .env

    - name: Wait for MySQL
      run: |
        cd backend
        npm install -g wait-port
        wait-port -h localhost -p 3307 -t 30000

    - name: Run Quality Gate Verification
      id: verification
      run: |
        cd backend
        npm run verify:backend:verbose
      continue-on-error: true

    - name: Upload Verification Report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: backend-verification-report
        path: |
          backend/reports/sprint4/post/backend-verification-report.json
          backend/coverage/
        retention-days: 30

    - name: Create Quality Summary
      if: always()
      run: |
        cd backend
        echo "## Backend Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "reports/sprint4/post/backend-verification-report.json" ]; then
          echo "### Verification Results" >> $GITHUB_STEP_SUMMARY
          
          # Extract key metrics from report
          SCORE=$(cat reports/sprint4/post/backend-verification-report.json | jq -r '.overall.summary.score // "N/A"')
          PASSED_STAGES=$(cat reports/sprint4/post/backend-verification-report.json | jq -r '.overall.summary.passedStages // "N/A"')
          TOTAL_STAGES=$(cat reports/sprint4/post/backend-verification-report.json | jq -r '.overall.summary.totalStages // "N/A"')
          DURATION=$(cat reports/sprint4/post/backend-verification-report.json | jq -r '.overall.summary.duration // "N/A"')
          
          echo "- **Score**: ${SCORE}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **Stages Passed**: ${PASSED_STAGES}/${TOTAL_STAGES}" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration**: ${DURATION}s" >> $GITHUB_STEP_SUMMARY
          
          # Show stage details
          echo "### Stage Results" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Score |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          cat reports/sprint4/post/backend-verification-report.json | jq -r '
            .stages | to_entries[] | 
            "| " + .value.name + " | " + .value.status + " | " + (.value.score | tostring) + "/100 |"
          ' >> $GITHUB_STEP_SUMMARY
          
        else
          echo "âŒ Verification report not generated" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Quality Gate Decision
      if: always()
      run: |
        cd backend
        if [ -f "reports/sprint4/post/backend-verification-report.json" ]; then
          PASSED=$(cat reports/sprint4/post/backend-verification-report.json | jq -r '.overall.passed')
          if [ "$PASSED" = "true" ]; then
            echo "âœ… Quality gate PASSED"
            exit 0
          else
            echo "âŒ Quality gate FAILED"
            exit 1
          fi
        else
          echo "âŒ Quality gate FAILED - no verification report"
          exit 1
        fi

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install Dependencies
      run: |
        cd backend
        npm ci

    - name: Run Security Audit
      run: |
        cd backend
        npm run security:audit

    - name: Run Dependency Check
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: backend/security-report.sarif
      continue-on-error: true

  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install Dependencies
      run: |
        cd backend
        npm ci

    - name: Performance Tests
      run: |
        cd backend
        npm run test:performance || echo "Performance tests not fully implemented"

    - name: Bundle Size Check
      run: |
        cd backend
        echo "Bundle size analysis - Node.js backend (no bundling required)"
        du -sh node_modules/

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install Dependencies
      run: |
        cd backend
        npm ci

    - name: Validate OpenAPI Spec
      run: |
        cd backend
        npm run spec:validate || echo "OpenAPI validation - implement when spec is available"

    - name: Lint OpenAPI Spec
      run: |
        cd backend
        npm run spec:lint || echo "OpenAPI linting - implement when spec is available"

    - name: Generate API Bundle
      run: |
        cd backend
        npm run spec:bundle || echo "API bundle generation - implement when spec is available"

  notify-status:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [quality-gate, security-audit, performance-check, documentation-check]
    if: always()
    
    steps:
    - name: Determine Overall Status
      run: |
        QUALITY_GATE_STATUS="${{ needs.quality-gate.result }}"
        SECURITY_STATUS="${{ needs.security-audit.result }}"
        
        echo "Quality Gate: $QUALITY_GATE_STATUS"
        echo "Security Audit: $SECURITY_STATUS"
        
        if [[ "$QUALITY_GATE_STATUS" == "success" && "$SECURITY_STATUS" == "success" ]]; then
          echo "ğŸ‰ All quality checks PASSED"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Quality checks FAILED"
          echo "status=failure" >> $GITHUB_OUTPUT
        fi

    - name: Create Status Comment (PR)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const qualityGate = '${{ needs.quality-gate.result }}';
          const security = '${{ needs.security-audit.result }}';
          const performance = '${{ needs.performance-check.result }}';
          const docs = '${{ needs.documentation-check.result }}';
          
          const statusIcon = (status) => {
            if (status === 'success') return 'âœ…';
            if (status === 'failure') return 'âŒ';
            if (status === 'cancelled') return 'â¹ï¸';
            return 'â³';
          };
          
          const body = `## ğŸ” Backend Quality Gate Results
          
          | Check | Status | Result |
          |-------|--------|---------|
          | Quality Gate | ${statusIcon(qualityGate)} | ${qualityGate} |
          | Security Audit | ${statusIcon(security)} | ${security} |
          | Performance Check | ${statusIcon(performance)} | ${performance} |
          | Documentation | ${statusIcon(docs)} | ${docs} |
          
          ${qualityGate === 'success' ? 'ğŸ‰ **Quality gate PASSED** - Ready for merge!' : 'âŒ **Quality gate FAILED** - Please fix issues before merging.'}
          
          ---
          <sub>Automated by Backend Quality Gate workflow</sub>`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });