<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cattle Management - Besteman Land & Cattle</title>

    <!-- 7D Solutions UI Kit -->
    <script src="ui-kit/js/mockup-core.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --color-primary: #8B4513;
            --color-primary-dark: #654321;
            --color-success: #28a745;
            --color-warning: #ffc107;
            --color-danger: #dc3545;
            --color-border: #dee2e6;
            --color-border-light: #e9ecef;
            --color-bg-light: #f8f9fa;
            --color-text: #333;
            --color-text-light: #666;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: var(--color-text);
        }

        .page-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: var(--space-5);
        }

        .page-header {
            background: white;
            padding: var(--space-5);
            border-radius: 8px;
            margin-bottom: var(--space-5);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .page-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-text);
        }

        .header-actions {
            display: flex;
            gap: var(--space-2);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .filters-section {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-border-light);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .filter-input,
        .filter-select {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        .datatable-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .datatable-toolbar {
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--color-bg-light);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .record-count {
            font-size: 14px;
            color: var(--color-text-light);
            font-weight: 500;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 3px;
        }

        .view-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 3px;
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text-light);
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--color-primary);
            color: white;
        }

        /* Column customization dropdown */
        .column-dropdown {
            position: relative;
            display: inline-block;
        }

        .column-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 220px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
            z-index: 1000;
            border: 1px solid var(--color-border);
            margin-top: 8px;
        }

        .column-dropdown-content.show {
            display: block;
        }

        .column-dropdown-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border-light);
            font-weight: 600;
            font-size: 13px;
            color: var(--color-text);
        }

        .column-dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .column-dropdown-item:hover {
            background: var(--color-bg-light);
        }

        .column-dropdown-item input[type="checkbox"] {
            cursor: pointer;
        }

        .column-dropdown-footer {
            padding: 8px 16px;
            border-top: 1px solid var(--color-border-light);
            text-align: right;
        }

        /* Edit mode styling */
        .table-edit-mode th {
            position: relative;
            padding-top: 50px !important;
        }

        .table-edit-mode th.sortable {
            cursor: move;
        }

        .column-checkbox-wrapper {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .column-checkbox-wrapper input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .column-checkbox-label {
            font-size: 11px;
            color: var(--color-text-light);
            font-weight: 500;
        }

        .drag-handle {
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--color-text-light);
            cursor: move;
            opacity: 0.4;
            transition: opacity 0.2s;
        }

        .table-edit-mode th:hover .drag-handle {
            opacity: 0.8;
        }

        /* Drag and drop visual feedback */
        .dragging {
            opacity: 0.5;
            background: var(--color-bg-light) !important;
        }

        .drag-over {
            border-left: 3px solid var(--color-primary) !important;
        }

        /* Card View Styles */
        .card-grid {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
            padding: 24px;
        }

        .card-grid.active {
            display: grid;
        }

        .cattle-card {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .cattle-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
            transform: translateY(-4px);
            border-color: var(--color-primary-light);
        }

        .card-header-section {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            padding: 20px 24px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-tag-id {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .card-status-badge {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
        }

        .card-body-section {
            padding: 20px 24px;
            background: #fafafa;
        }

        .card-info-row {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid #e8e8e8;
            align-items: center;
        }

        .card-info-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .card-info-row:first-child {
            padding-top: 0;
        }

        .card-info-row.card-highlight {
            background: #fff8e1;
            margin: 12px -24px 0;
            padding: 12px 24px;
            border-bottom: none;
        }

        .card-label {
            font-size: 13px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .card-value {
            font-size: 15px;
            color: var(--color-text);
            font-weight: 600;
            text-align: right;
        }

        .card-highlight .card-label {
            color: #f57c00;
        }

        .card-highlight .card-value {
            color: #e65100;
        }

        .card-actions {
            padding: 16px 24px;
            background: white;
            display: flex;
            gap: 12px;
            border-top: 1px solid var(--color-border-light);
        }

        .card-actions .btn {
            flex: 1;
            justify-content: center;
            font-weight: 600;
            padding: 10px 16px;
        }

        /* Hide table when card view active */
        .table-wrapper.hidden {
            display: none;
        }

        .edit-mode-badge {
            background: var(--color-primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        .datatable {
            width: 100%;
            border-collapse: collapse;
        }

        .datatable thead {
            background: var(--color-bg-light);
            border-bottom: 2px solid var(--color-border);
        }

        .datatable th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: var(--color-text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .datatable th.sortable {
            cursor: pointer;
            user-select: none;
        }

        .datatable th.sortable:hover {
            background: #e9ecef;
        }

        .datatable th .sort-icon {
            margin-left: 5px;
            opacity: 0.3;
        }

        .datatable th.sorted .sort-icon {
            opacity: 1;
        }

        .datatable tbody tr {
            border-bottom: 1px solid var(--color-border-light);
            transition: background 0.2s;
            cursor: pointer;
        }

        .datatable tbody tr:hover {
            background: #f8f9fa;
        }

        .datatable tbody tr.expanded {
            background: #f5ebe0;
        }

        .datatable tbody tr.expanded:hover {
            background: #ead5c2;
        }

        .datatable td {
            padding: var(--space-3) var(--space-4);
            font-size: 14px;
            color: var(--color-text);
        }

        .expand-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 20px;
            transition: transform 0.2s;
            font-size: 16px;
        }

        .expanded .expand-icon {
            transform: rotate(90deg);
        }

        .cow-id {
            font-weight: 700;
            color: var(--color-primary);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-pregnant {
            background: #fff3cd;
            color: #856404;
        }

        .status-dry {
            background: #f8d7da;
            color: #721c24;
        }

        .status-sold {
            background: #e2e3e5;
            color: #383d41;
        }

        .expanded-row {
            display: none;
        }

        .expanded-row.show {
            display: table-row;
        }

        .expanded-content {
            padding: 0;
            background: #f8f9fa;
            border-top: 2px solid var(--color-primary);
        }

        /* Calf expanded rows */
        .calf-row {
            cursor: pointer;
        }

        .calf-row:hover {
            background-color: #f8f9fa;
        }

        .calf-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .calf-expanded-row {
            display: none;
        }

        .calf-expanded-row.show {
            display: table-row;
        }

        .calf-expanded-content {
            padding: 0;
            background: #fff;
        }

        .calf-work-section {
            padding: 16px;
            background: #f8f9fa;
            border-left: 3px solid var(--color-primary);
            margin: 8px;
            border-radius: 4px;
        }

        .expanded-inner {
            padding: var(--space-5);
        }

        .history-tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            border-bottom: 2px solid var(--color-border);
        }

        .history-tab {
            padding: var(--space-3) var(--space-5);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
            bottom: -2px;
        }

        .history-tab:hover {
            color: var(--color-primary);
        }

        .history-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-5);
            padding: var(--space-4);
            background: white;
            border-radius: 6px;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .summary-label {
            font-size: 11px;
            font-weight: 700;
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
        }

        .history-table thead {
            background: #f8f9fa;
        }

        .history-table th {
            padding: var(--space-3);
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: var(--color-text);
            text-transform: uppercase;
            border-bottom: 2px solid var(--color-border);
        }

        .history-table td {
            padding: var(--space-3);
            font-size: 13px;
            border-bottom: 1px solid var(--color-border-light);
        }

        .history-table tbody tr:hover {
            background: #f8f9fa;
        }

        .gender-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .gender-male {
            background: #cce5ff;
            color: #004085;
        }

        .gender-female {
            background: #f8d7da;
            color: #721c24;
        }

        .activity-type {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }

        .activity-icon {
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: var(--space-5);
            color: var(--color-text-light);
            font-style: italic;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            border-top: 1px solid var(--color-border-light);
            background: var(--color-bg-light);
        }

        .pagination-info {
            font-size: 14px;
            color: var(--color-text-light);
        }

        .pagination-controls {
            display: flex;
            gap: var(--space-2);
        }

        .page-btn {
            padding: 6px 12px;
            border: 1px solid var(--color-border);
            background: white;
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .highlight-metric {
            color: var(--color-primary);
            font-weight: 700;
        }

        .action-link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .action-link:hover {
            text-decoration: underline;
        }

        /* Modal Styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-backdrop.show {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.show {
            display: block;
        }

        .modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-text);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--color-text-light);
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--color-text);
        }

        .modal-body {
            padding: var(--space-5);
        }

        .modal-footer {
            padding: var(--space-4);
            border-top: 1px solid var(--color-border-light);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-2);
        }

        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: 600;
            font-size: 14px;
            color: var(--color-text);
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--space-3);
        }

        .add-item-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: var(--space-3);
        }

        .add-item-btn:hover {
            background: var(--color-primary-dark);
        }

        /* Mobile Responsive Breakpoints */
        @media (max-width: 768px) {
            /* Auto-switch to card view on mobile - DISABLED */
            /* #table-view {
                display: none !important;
            }

            #card-view {
                display: grid !important;
            } */

            /* Hide view toggle on mobile - DISABLED */
            /* .view-toggle {
                display: none;
            } */

            /* Stack toolbar items vertically on mobile */
            .datatable-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-left {
                margin-bottom: var(--space-2);
            }

            /* Adjust card layout for mobile */
            .card-grid {
                grid-template-columns: 1fr;
                padding: var(--space-3);
            }

            /* Larger touch targets for mobile */
            .card-actions .btn {
                padding: 10px 16px;
                font-size: 14px;
            }

            /* Adjust header for mobile */
            .page-header {
                padding: var(--space-3);
            }

            h1 {
                font-size: 24px;
            }

            /* Adjust filter bar for mobile */
            .filter-bar {
                flex-direction: column;
                gap: var(--space-2);
            }

            .filter-group {
                flex: 1 1 100%;
            }
        }

        @media (min-width: 769px) and (max-width: 1199px) {
            /* Tablet: 2 columns */
            .card-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                padding: 20px;
            }
        }

        @media (min-width: 1200px) and (max-width: 1599px) {
            /* Desktop: 3 columns */
            .card-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1600px) {
            /* Large Desktop: 4 columns */
            .card-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="page-header-top">
                <h1 class="page-title">üêÑ Cattle Management</h1>
                <div class="header-actions">
                    <button class="btn btn-secondary">üìä Export Report</button>
                    <button class="btn btn-success" onclick="showAddCowModal()">‚ûï Add New Cow</button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">Search</label>
                    <input type="text" id="search-input" class="filter-input" placeholder="Tag ID, Breed..." style="width: 250px;">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Status</label>
                    <select id="status-filter" class="filter-select" style="width: 150px;">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="pregnant">Pregnant</option>
                        <option value="dry">Dry</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Breed</label>
                    <select id="breed-filter" class="filter-select" style="width: 150px;">
                        <option value="">All Breeds</option>
                        <option value="Angus">Angus</option>
                        <option value="Hereford">Hereford</option>
                        <option value="Charolais">Charolais</option>
                        <option value="Simmental">Simmental</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Age Range</label>
                    <select id="age-filter" class="filter-select" style="width: 130px;">
                        <option value="">All Ages</option>
                        <option value="0-2">0-2 years</option>
                        <option value="2-5">2-5 years</option>
                        <option value="5+">5+ years</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" style="opacity: 0; pointer-events: none;">-</label>
                    <button class="btn btn-secondary" onclick="resetFilters()">‚úï Clear Filters</button>
                </div>
            </div>
        </div>

        <!-- DataTable Container -->
        <div class="datatable-container">
            <!-- Toolbar -->
            <div class="datatable-toolbar">
                <div class="toolbar-left">
                    <span class="record-count">Showing <strong id="cow-count">0</strong> cows</span>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button class="btn btn-secondary" onclick="toggleEditMode()" id="edit-columns-btn" style="padding: 6px 12px; font-size: 13px;">
                        ‚öôÔ∏è Edit Columns
                    </button>
                    <button class="btn btn-secondary" onclick="resetColumns()" id="reset-columns-btn" style="padding: 6px 12px; font-size: 13px; display: none;">
                        Reset Columns
                    </button>
                    <div class="view-toggle">
                        <button id="table-view-btn" class="btn btn-primary btn-sm" onclick="switchView('table')">üìã Table</button>
                        <button id="card-view-btn" class="btn btn-secondary btn-sm" onclick="switchView('cards')">üìá Cards</button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="table-wrapper" id="table-view">
                <table class="datatable" id="cattle-table">
                    <thead>
                        <tr id="table-header">
                            <!-- Headers will be rendered dynamically -->
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Data will be rendered here -->
                    </tbody>
                </table>
            </div>

            <!-- Card Grid -->
            <div class="card-grid" id="card-view">
                <!-- Cards will be rendered here -->
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-info">
                    Showing <span id="pagination-info">0-0 of 0</span> cows
                </div>
                <div class="pagination-controls">
                    <button class="page-btn" disabled>Previous</button>
                    <button class="page-btn active">1</button>
                    <button class="page-btn">2</button>
                    <button class="page-btn">3</button>
                    <button class="page-btn">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="modal-backdrop"></div>

    <!-- Add/Edit Cow Modal -->
    <div id="cow-modal" class="modal">
        <div class="modal-header">
            <h2 class="modal-title" id="cow-modal-title">Add New Cow</h2>
            <button class="modal-close" onclick="closeModal('cow-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="cow-form" onsubmit="saveCow(event)">
                <input type="hidden" id="cow-id">

                <div class="form-group">
                    <label class="form-label">Tag ID *</label>
                    <input type="text" class="form-control" id="cow-tagId" required placeholder="e.g., #A-1247">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Breed *</label>
                        <select class="form-control" id="cow-breed" required>
                            <option value="">Select breed</option>
                            <option>Black Angus</option>
                            <option>Red Angus</option>
                            <option>Hereford</option>
                            <option>Charolais</option>
                            <option>Simmental</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Age *</label>
                        <input type="text" class="form-control" id="cow-age" required placeholder="e.g., 4.2 years">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Weight (lbs) *</label>
                        <input type="number" class="form-control" id="cow-weight" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-control" id="cow-status" required>
                            <option>active</option>
                            <option>pregnant</option>
                            <option>dry</option>
                            <option>sold</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Purchase Date</label>
                        <input type="date" class="form-control" id="cow-purchaseDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Color/Markings</label>
                        <input type="text" class="form-control" id="cow-color">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Body Condition</label>
                        <input type="text" class="form-control" id="cow-bodyCondition" placeholder="e.g., 6/9 (Good)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Avg Weaning Weight</label>
                        <input type="number" class="form-control" id="cow-avgWeaningWeight">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Dam ID</label>
                        <input type="text" class="form-control" id="cow-damId">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sire ID</label>
                        <input type="text" class="form-control" id="cow-sireId">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('cow-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveCow(event)">Save Cow</button>
        </div>
    </div>

    <!-- Add Calf Modal -->
    <div id="calf-modal" class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Add Calf</h2>
            <button class="modal-close" onclick="closeModal('calf-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="calf-form" onsubmit="saveCalf(event)">
                <input type="hidden" id="calf-parentId">

                <div class="form-group">
                    <label class="form-label">Calf ID *</label>
                    <input type="text" class="form-control" id="calf-calfId" required>
                </div>

                <div class="form-row-3">
                    <div class="form-group">
                        <label class="form-label">Birth Date *</label>
                        <input type="date" class="form-control" id="calf-birthDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gender *</label>
                        <select class="form-control" id="calf-gender" required>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Birth Weight (lbs) *</label>
                        <input type="number" class="form-control" id="calf-birthWeight" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Current Weight (lbs)</label>
                        <input type="number" class="form-control" id="calf-currentWeight">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-control" id="calf-status" required>
                            <option value="nursing">Nursing</option>
                            <option value="weaned">Weaned</option>
                            <option value="sold">Sold</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Weaning Weight (lbs)</label>
                        <input type="number" class="form-control" id="calf-weaningWeight">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Weaning Age</label>
                        <input type="text" class="form-control" id="calf-weaningAge" placeholder="e.g., 7.5 months">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('calf-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveCalf(event)">Save Calf</button>
        </div>
    </div>

    <!-- Add Work History Modal -->
    <div id="work-modal" class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Add Work History</h2>
            <button class="modal-close" onclick="closeModal('work-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="work-form" onsubmit="saveWork(event)">
                <input type="hidden" id="work-cattleId">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-control" id="work-date" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Activity Type *</label>
                        <select class="form-control" id="work-activityType" required onchange="updateActivityIcon()">
                            <option value="vaccination">Vaccination</option>
                            <option value="deworming">Deworming</option>
                            <option value="weighing">Weighing</option>
                            <option value="hoof-trim">Hoof Trim</option>
                            <option value="pregnancy-test">Pregnancy Test</option>
                            <option value="treatment">Treatment</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Details *</label>
                    <input type="text" class="form-control" id="work-details" required placeholder="e.g., Cattle Master 4">
                </div>

                <div class="form-group">
                    <label class="form-label">Administered By *</label>
                    <input type="text" class="form-control" id="work-administeredBy" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="work-notes"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('work-modal')">Cancel</button>
            <button class="btn btn-primary" onclick="saveWork(event)">Save Work History</button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-header">
            <h2 class="modal-title">‚ö†Ô∏è Confirm Action</h2>
            <button class="modal-close" onclick="closeModal('confirm-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirm-message" style="font-size: 16px; line-height: 1.6;"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('confirm-modal')">Cancel</button>
            <button class="btn btn-danger" id="confirm-btn">Delete</button>
        </div>
    </div>

    <!-- Cow Detail Modal (for card view) -->
    <div id="detail-modal" class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h2 class="modal-title" id="detail-modal-title">Cow Details</h2>
            <button class="modal-close" onclick="closeModal('detail-modal')">&times;</button>
        </div>
        <div class="modal-body" id="detail-modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Content will be rendered dynamically -->
        </div>
        <div class="modal-footer" style="display: flex; justify-content: space-between;">
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-primary" id="detail-edit-btn" onclick="editCowFromDetail()">Edit</button>
                <button class="btn btn-danger" id="detail-delete-btn" onclick="deleteCowFromDetail()">Delete</button>
            </div>
            <button class="btn btn-secondary" onclick="closeModal('detail-modal')">Close</button>
        </div>
    </div>

    <script>
        // Initialize data stores
        const cattleStore = new MockupStore('cattle-records');
        const calfStore = new MockupStore('calf-history');
        const workStore = new MockupStore('work-history');

        let currentCowId = null;
        let confirmCallback = null;

        // Add sample data
        function initSampleData() {
            // Data version - increment this to force reload of sample data
            const DATA_VERSION = 5;
            const currentVersion = sessionStorage.getItem('cattle-data-version');

            // Clear old data if version changed
            if (currentVersion !== String(DATA_VERSION)) {
                sessionStorage.clear();
                sessionStorage.setItem('cattle-data-version', DATA_VERSION);
            }

            if (cattleStore.getAll().length === 0) {
                const sampleCattle = [
                    {
                        tagId: '#A-1247',
                        breed: 'Black Angus',
                        age: '4.2 years',
                        weight: 1280,
                        status: 'active',
                        totalCalves: 5,
                        lastCalving: '2024-02-12',
                        currentCalf: '#A-1247-C5',
                        purchaseDate: '2020-05-10',
                        color: 'Solid Black',
                        avgWeaningWeight: 542,
                        bodyCondition: '6/9 (Good)',
                        damId: '#A-0892',
                        sireId: '#BULL-027'
                    },
                    {
                        tagId: '#H-2031',
                        breed: 'Hereford',
                        age: '3.7 years',
                        weight: 1340,
                        status: 'pregnant',
                        totalCalves: 3,
                        lastCalving: '2024-02-28',
                        currentCalf: '#H-2031-C3',
                        purchaseDate: '2021-01-15',
                        color: 'Red/White Face',
                        avgWeaningWeight: 568,
                        bodyCondition: '7/9 (Excellent)',
                        dueDate: '2025-01-15',
                        daysPregnant: '~210 days'
                    },
                    {
                        tagId: '#A-1893',
                        breed: 'Black Angus',
                        age: '5.8 years',
                        weight: 1310,
                        status: 'active',
                        totalCalves: 6,
                        lastCalving: '2024-01-20',
                        currentCalf: '#A-1893-C6',
                        purchaseDate: '2019-03-12',
                        color: 'Solid Black',
                        avgWeaningWeight: 558,
                        bodyCondition: '7/9 (Excellent)',
                        damId: '#A-0745',
                        sireId: '#BULL-027'
                    },
                    {
                        tagId: '#H-1556',
                        breed: 'Hereford',
                        age: '2.3 years',
                        weight: 1180,
                        status: 'active',
                        totalCalves: 1,
                        lastCalving: '2024-03-15',
                        currentCalf: '#H-1556-C1',
                        purchaseDate: '2022-06-20',
                        color: 'Red/White Face',
                        avgWeaningWeight: 510,
                        bodyCondition: '6/9 (Good)',
                        damId: '#H-0892',
                        sireId: '#BULL-014'
                    },
                    {
                        tagId: '#R-2104',
                        breed: 'Red Angus',
                        age: '3.1 years',
                        weight: 1255,
                        status: 'active',
                        totalCalves: 2,
                        lastCalving: '2024-04-08',
                        currentCalf: '#R-2104-C2',
                        purchaseDate: '2021-09-10',
                        color: 'Solid Red',
                        avgWeaningWeight: 535,
                        bodyCondition: '6/9 (Good)',
                        damId: '#R-1203',
                        sireId: '#BULL-019'
                    },
                    {
                        tagId: '#A-2245',
                        breed: 'Black Angus',
                        age: '6.5 years',
                        weight: 1395,
                        status: 'dry',
                        totalCalves: 7,
                        lastCalving: '2023-11-10',
                        currentCalf: null,
                        purchaseDate: '2018-05-15',
                        color: 'Solid Black',
                        avgWeaningWeight: 575,
                        bodyCondition: '8/9 (Excellent)',
                        damId: '#A-0456',
                        sireId: '#BULL-027'
                    },
                    {
                        tagId: '#CH-3012',
                        breed: 'Charolais',
                        age: '4.9 years',
                        weight: 1450,
                        status: 'pregnant',
                        totalCalves: 4,
                        lastCalving: '2024-01-05',
                        currentCalf: '#CH-3012-C4',
                        purchaseDate: '2020-02-28',
                        color: 'White/Cream',
                        avgWeaningWeight: 605,
                        bodyCondition: '7/9 (Excellent)',
                        damId: '#CH-1567',
                        sireId: '#BULL-022',
                        dueDate: '2025-02-10',
                        daysPregnant: '~180 days'
                    },
                    {
                        tagId: '#H-1788',
                        breed: 'Hereford',
                        age: '7.2 years',
                        weight: 1365,
                        status: 'active',
                        totalCalves: 8,
                        lastCalving: '2024-02-22',
                        currentCalf: '#H-1788-C8',
                        purchaseDate: '2017-08-05',
                        color: 'Red/White Face',
                        avgWeaningWeight: 590,
                        bodyCondition: '6/9 (Good)',
                        damId: '#H-0334',
                        sireId: '#BULL-014'
                    },
                    // Additional cattle for pagination testing
                    {
                        tagId: '#A-2567',
                        breed: 'Black Angus',
                        age: '3.5 years',
                        weight: 1245,
                        status: 'active',
                        totalCalves: 3,
                        lastCalving: '2024-05-10',
                        currentCalf: '#A-2567-C3',
                        purchaseDate: '2021-08-22',
                        color: 'Solid Black',
                        avgWeaningWeight: 525,
                        bodyCondition: '6/9 (Good)',
                        damId: '#A-1234',
                        sireId: '#BULL-027'
                    },
                    {
                        tagId: '#R-3421',
                        breed: 'Red Angus',
                        age: '4.8 years',
                        weight: 1300,
                        status: 'pregnant',
                        totalCalves: 4,
                        lastCalving: '2024-03-18',
                        currentCalf: '#R-3421-C4',
                        purchaseDate: '2020-04-15',
                        color: 'Solid Red',
                        avgWeaningWeight: 548,
                        bodyCondition: '7/9 (Excellent)',
                        damId: '#R-1567',
                        sireId: '#BULL-019',
                        dueDate: '2025-03-05',
                        daysPregnant: '~165 days'
                    },
                    {
                        tagId: '#H-2891',
                        breed: 'Hereford',
                        age: '5.3 years',
                        weight: 1355,
                        status: 'active',
                        totalCalves: 5,
                        lastCalving: '2024-04-22',
                        currentCalf: '#H-2891-C5',
                        purchaseDate: '2019-10-12',
                        color: 'Red/White Face',
                        avgWeaningWeight: 572,
                        bodyCondition: '7/9 (Excellent)',
                        damId: '#H-1234',
                        sireId: '#BULL-014'
                    },
                    {
                        tagId: '#A-3012',
                        breed: 'Black Angus',
                        age: '2.9 years',
                        weight: 1195,
                        status: 'active',
                        totalCalves: 2,
                        lastCalving: '2024-06-15',
                        currentCalf: '#A-3012-C2',
                        purchaseDate: '2022-02-20',
                        color: 'Solid Black',
                        avgWeaningWeight: 515,
                        bodyCondition: '6/9 (Good)',
                        damId: '#A-1678',
                        sireId: '#BULL-027'
                    },
                    {
                        tagId: '#CH-1567',
                        breed: 'Charolais',
                        age: '6.1 years',
                        weight: 1480,
                        status: 'active',
                        totalCalves: 6,
                        lastCalving: '2024-01-30',
                        currentCalf: '#CH-1567-C6',
                        purchaseDate: '2018-11-08',
                        color: 'White/Cream',
                        avgWeaningWeight: 620,
                        bodyCondition: '8/9 (Excellent)',
                        damId: '#CH-0987',
                        sireId: '#BULL-022'
                    },
                    {
                        tagId: '#R-1945',
                        breed: 'Red Angus',
                        age: '3.2 years',
                        weight: 1265,
                        status: 'active',
                        totalCalves: 2,
                        lastCalving: '2024-07-08',
                        currentCalf: '#R-1945-C2',
                        purchaseDate: '2021-11-15',
                        color: 'Solid Red',
                        avgWeaningWeight: 538,
                        bodyCondition: '6/9 (Good)',
                        damId: '#R-0845',
                        sireId: '#BULL-019'
                    },
                    {
                        tagId: '#H-3156',
                        breed: 'Hereford',
                        age: '4.5 years',
                        weight: 1325,
                        status: 'pregnant',
                        totalCalves: 4,
                        lastCalving: '2024-02-14',
                        currentCalf: '#H-3156-C4',
                        purchaseDate: '2020-06-20',
                        color: 'Red/White Face',
                        avgWeaningWeight: 560,
                        bodyCondition: '7/9 (Excellent)',
                        damId: '#H-1890',
                        sireId: '#BULL-014',
                        dueDate: '2025-01-25',
                        daysPregnant: '~195 days'
                    },
                    {
                        tagId: '#A-1678',
                        breed: 'Black Angus',
                        age: '5.7 years',
                        weight: 1295,
                        status: 'active',
                        totalCalves: 5,
                        lastCalving: '2024-03-22',
                        currentCalf: '#A-1678-C5',
                        purchaseDate: '2019-05-18',
                        color: 'Solid Black',
                        avgWeaningWeight: 555,
                        bodyCondition: '7/9 (Excellent)',
                        damId: '#A-0912',
                        sireId: '#BULL-027'
                    },
                    {
                        tagId: '#CH-2345',
                        breed: 'Charolais',
                        age: '3.8 years',
                        weight: 1420,
                        status: 'active',
                        totalCalves: 3,
                        lastCalving: '2024-04-05',
                        currentCalf: '#CH-2345-C3',
                        purchaseDate: '2021-03-10',
                        color: 'White/Cream',
                        avgWeaningWeight: 595,
                        bodyCondition: '7/9 (Excellent)',
                        damId: '#CH-1234',
                        sireId: '#BULL-022'
                    },
                    {
                        tagId: '#R-2678',
                        breed: 'Red Angus',
                        age: '2.5 years',
                        weight: 1215,
                        status: 'active',
                        totalCalves: 1,
                        lastCalving: '2024-08-12',
                        currentCalf: '#R-2678-C1',
                        purchaseDate: '2022-07-15',
                        color: 'Solid Red',
                        avgWeaningWeight: 505,
                        bodyCondition: '6/9 (Good)',
                        damId: '#R-1456',
                        sireId: '#BULL-019'
                    },
                    {
                        tagId: '#H-1234',
                        breed: 'Hereford',
                        age: '6.8 years',
                        weight: 1370,
                        status: 'dry',
                        totalCalves: 7,
                        lastCalving: '2023-12-10',
                        currentCalf: null,
                        purchaseDate: '2018-02-22',
                        color: 'Red/White Face',
                        avgWeaningWeight: 585,
                        bodyCondition: '7/9 (Excellent)',
                        damId: '#H-0567',
                        sireId: '#BULL-014'
                    },
                    {
                        tagId: '#A-2890',
                        breed: 'Black Angus',
                        age: '4.1 years',
                        weight: 1270,
                        status: 'pregnant',
                        totalCalves: 4,
                        lastCalving: '2024-01-18',
                        currentCalf: '#A-2890-C4',
                        purchaseDate: '2020-09-05',
                        color: 'Solid Black',
                        avgWeaningWeight: 540,
                        bodyCondition: '7/9 (Excellent)',
                        damId: '#A-1345',
                        sireId: '#BULL-027',
                        dueDate: '2025-02-20',
                        daysPregnant: '~175 days'
                    },
                    {
                        tagId: '#CH-1890',
                        breed: 'Charolais',
                        age: '5.5 years',
                        weight: 1465,
                        status: 'active',
                        totalCalves: 5,
                        lastCalving: '2024-02-28',
                        currentCalf: '#CH-1890-C5',
                        purchaseDate: '2019-07-12',
                        color: 'White/Cream',
                        avgWeaningWeight: 610,
                        bodyCondition: '8/9 (Excellent)',
                        damId: '#CH-0678',
                        sireId: '#BULL-022'
                    }
                ];

                sampleCattle.forEach(c => {
                    // Use tagId as the ID instead of auto-generated
                    const cowData = { ...c, id: c.tagId };
                    cattleStore.data.push(cowData);
                });
                cattleStore.save();

                // Sample calf history - Multiple calves per cow
                const sampleCalves = [
                    // A-1247 calves
                    { cattleId: '#A-1247', calfId: '#A-1247-C5', birthDate: '2024-02-12', gender: 'male', birthWeight: 82, currentWeight: 387, status: 'nursing' },
                    { cattleId: '#A-1247', calfId: '#A-1247-C4', birthDate: '2023-03-05', gender: 'female', birthWeight: 78, weaningWeight: 548, weaningAge: '7.5 months', status: 'weaned' },
                    { cattleId: '#A-1247', calfId: '#A-1247-C3', birthDate: '2022-02-18', gender: 'male', birthWeight: 85, weaningWeight: 562, weaningAge: '7 months', status: 'sold' },

                    // H-2031 calves
                    { cattleId: '#H-2031', calfId: '#H-2031-C3', birthDate: '2024-02-28', gender: 'female', birthWeight: 76, currentWeight: 365, status: 'nursing' },
                    { cattleId: '#H-2031', calfId: '#H-2031-C2', birthDate: '2023-04-12', gender: 'male', birthWeight: 80, weaningWeight: 575, weaningAge: '8 months', status: 'weaned' },

                    // A-1893 calves
                    { cattleId: '#A-1893', calfId: '#A-1893-C6', birthDate: '2024-01-20', gender: 'female', birthWeight: 79, currentWeight: 412, status: 'nursing' },
                    { cattleId: '#A-1893', calfId: '#A-1893-C5', birthDate: '2023-02-08', gender: 'male', birthWeight: 83, weaningWeight: 568, weaningAge: '7.5 months', status: 'sold' },
                    { cattleId: '#A-1893', calfId: '#A-1893-C4', birthDate: '2022-03-15', gender: 'female', birthWeight: 77, weaningWeight: 545, weaningAge: '8 months', status: 'sold' },

                    // H-1556 calves
                    { cattleId: '#H-1556', calfId: '#H-1556-C1', birthDate: '2024-03-15', gender: 'male', birthWeight: 74, currentWeight: 325, status: 'nursing' },

                    // R-2104 calves
                    { cattleId: '#R-2104', calfId: '#R-2104-C2', birthDate: '2024-04-08', gender: 'female', birthWeight: 81, currentWeight: 298, status: 'nursing' },
                    { cattleId: '#R-2104', calfId: '#R-2104-C1', birthDate: '2023-05-20', gender: 'male', birthWeight: 78, weaningWeight: 528, weaningAge: '7 months', status: 'weaned' },

                    // CH-3012 calves
                    { cattleId: '#CH-3012', calfId: '#CH-3012-C4', birthDate: '2024-01-05', gender: 'male', birthWeight: 92, currentWeight: 445, status: 'nursing' },
                    { cattleId: '#CH-3012', calfId: '#CH-3012-C3', birthDate: '2023-01-28', gender: 'female', birthWeight: 88, weaningWeight: 615, weaningAge: '8 months', status: 'sold' },

                    // H-1788 calves
                    { cattleId: '#H-1788', calfId: '#H-1788-C8', birthDate: '2024-02-22', gender: 'male', birthWeight: 84, currentWeight: 395, status: 'nursing' },
                    { cattleId: '#H-1788', calfId: '#H-1788-C7', birthDate: '2023-03-10', gender: 'female', birthWeight: 79, weaningWeight: 598, weaningAge: '8 months', status: 'weaned' },

                    // A-3012 calves
                    { cattleId: '#A-3012', calfId: '#A-3012-C2', birthDate: '2024-06-15', gender: 'male', birthWeight: 80, currentWeight: 285, status: 'nursing' },
                    { cattleId: '#A-3012', calfId: '#A-3012-C1', birthDate: '2023-07-20', gender: 'female', birthWeight: 76, weaningWeight: 520, weaningAge: '7 months', status: 'weaned' },

                    // A-2567 calves
                    { cattleId: '#A-2567', calfId: '#A-2567-C3', birthDate: '2024-05-10', gender: 'female', birthWeight: 78, currentWeight: 305, status: 'nursing' },
                    { cattleId: '#A-2567', calfId: '#A-2567-C2', birthDate: '2023-06-15', gender: 'male', birthWeight: 81, weaningWeight: 530, weaningAge: '7.5 months', status: 'weaned' },

                    // R-3421 calves
                    { cattleId: '#R-3421', calfId: '#R-3421-C4', birthDate: '2024-03-18', gender: 'male', birthWeight: 79, currentWeight: 340, status: 'nursing' },
                    { cattleId: '#R-3421', calfId: '#R-3421-C3', birthDate: '2023-04-22', gender: 'female', birthWeight: 77, weaningWeight: 545, weaningAge: '8 months', status: 'sold' },

                    // H-2891 calves
                    { cattleId: '#H-2891', calfId: '#H-2891-C5', birthDate: '2024-04-22', gender: 'female', birthWeight: 82, currentWeight: 320, status: 'nursing' },
                    { cattleId: '#H-2891', calfId: '#H-2891-C4', birthDate: '2023-05-08', gender: 'male', birthWeight: 84, weaningWeight: 580, weaningAge: '8 months', status: 'weaned' },

                    // CH-1567 calves
                    { cattleId: '#CH-1567', calfId: '#CH-1567-C6', birthDate: '2024-01-30', gender: 'male', birthWeight: 90, currentWeight: 425, status: 'nursing' },
                    { cattleId: '#CH-1567', calfId: '#CH-1567-C5', birthDate: '2023-02-12', gender: 'female', birthWeight: 88, weaningWeight: 610, weaningAge: '8.5 months', status: 'sold' },

                    // R-1945 calves
                    { cattleId: '#R-1945', calfId: '#R-1945-C2', birthDate: '2024-07-08', gender: 'male', birthWeight: 80, currentWeight: 265, status: 'nursing' },
                    { cattleId: '#R-1945', calfId: '#R-1945-C1', birthDate: '2023-08-10', gender: 'female', birthWeight: 78, weaningWeight: 535, weaningAge: '7 months', status: 'weaned' },

                    // H-3156 calves
                    { cattleId: '#H-3156', calfId: '#H-3156-C4', birthDate: '2024-02-14', gender: 'female', birthWeight: 81, currentWeight: 380, status: 'nursing' },
                    { cattleId: '#H-3156', calfId: '#H-3156-C3', birthDate: '2023-03-20', gender: 'male', birthWeight: 79, weaningWeight: 565, weaningAge: '8 months', status: 'sold' },

                    // A-1678 calves
                    { cattleId: '#A-1678', calfId: '#A-1678-C5', birthDate: '2024-03-22', gender: 'male', birthWeight: 83, currentWeight: 350, status: 'nursing' },
                    { cattleId: '#A-1678', calfId: '#A-1678-C4', birthDate: '2023-04-05', gender: 'female', birthWeight: 80, weaningWeight: 560, weaningAge: '7.5 months', status: 'weaned' },

                    // CH-2345 calves
                    { cattleId: '#CH-2345', calfId: '#CH-2345-C3', birthDate: '2024-04-05', gender: 'female', birthWeight: 89, currentWeight: 395, status: 'nursing' },
                    { cattleId: '#CH-2345', calfId: '#CH-2345-C2', birthDate: '2023-05-15', gender: 'male', birthWeight: 91, weaningWeight: 600, weaningAge: '8 months', status: 'sold' },

                    // R-2678 calves
                    { cattleId: '#R-2678', calfId: '#R-2678-C1', birthDate: '2024-08-12', gender: 'female', birthWeight: 77, currentWeight: 245, status: 'nursing' },

                    // A-2890 calves
                    { cattleId: '#A-2890', calfId: '#A-2890-C4', birthDate: '2024-01-18', gender: 'male', birthWeight: 82, currentWeight: 435, status: 'nursing' },
                    { cattleId: '#A-2890', calfId: '#A-2890-C3', birthDate: '2023-02-25', gender: 'female', birthWeight: 79, weaningWeight: 545, weaningAge: '7.5 months', status: 'weaned' },

                    // CH-1890 calves
                    { cattleId: '#CH-1890', calfId: '#CH-1890-C5', birthDate: '2024-02-28', gender: 'female', birthWeight: 90, currentWeight: 405, status: 'nursing' },
                    { cattleId: '#CH-1890', calfId: '#CH-1890-C4', birthDate: '2023-03-12', gender: 'male', birthWeight: 92, weaningWeight: 625, weaningAge: '8.5 months', status: 'sold' },

                    // A-2245 calves (dry cow - all calves weaned/sold)
                    { cattleId: '#A-2245', calfId: '#A-2245-C7', birthDate: '2023-11-10', gender: 'male', birthWeight: 84, weaningWeight: 580, weaningAge: '7.5 months', status: 'sold' },
                    { cattleId: '#A-2245', calfId: '#A-2245-C6', birthDate: '2022-12-15', gender: 'female', birthWeight: 82, weaningWeight: 575, weaningAge: '8 months', status: 'sold' },
                    { cattleId: '#A-2245', calfId: '#A-2245-C5', birthDate: '2022-01-20', gender: 'male', birthWeight: 85, weaningWeight: 590, weaningAge: '7 months', status: 'sold' },
                    { cattleId: '#A-2245', calfId: '#A-2245-C4', birthDate: '2021-02-08', gender: 'female', birthWeight: 80, weaningWeight: 570, weaningAge: '8 months', status: 'sold' },

                    // H-1234 calves (dry cow - all calves weaned/sold)
                    { cattleId: '#H-1234', calfId: '#H-1234-C7', birthDate: '2023-12-10', gender: 'female', birthWeight: 81, weaningWeight: 595, weaningAge: '8 months', status: 'sold' },
                    { cattleId: '#H-1234', calfId: '#H-1234-C6', birthDate: '2023-01-05', gender: 'male', birthWeight: 83, weaningWeight: 585, weaningAge: '8.5 months', status: 'sold' },
                    { cattleId: '#H-1234', calfId: '#H-1234-C5', birthDate: '2022-02-18', gender: 'female', birthWeight: 79, weaningWeight: 580, weaningAge: '8 months', status: 'sold' }
                ];
                sampleCalves.forEach(c => {
                    // Use calfId as the ID instead of auto-generated
                    const calfData = { ...c, id: c.calfId };
                    calfStore.data.push(calfData);
                });
                calfStore.save();

                // Sample work history - For both cows and calves
                const sampleWork = [
                    // Cow #A-1247 work history
                    { cattleId: '#A-1247', date: '2024-11-08', activityType: 'vaccination', details: 'Cattle Master 4 (IBR, BVD, PI3, BRSV)', administeredBy: 'Dr. Sarah Williams', notes: 'Annual vaccination, no reactions' },
                    { cattleId: '#A-1247', date: '2024-11-05', activityType: 'deworming', details: 'Ivermectin Pour-On (58ml)', administeredBy: 'John Smith', notes: 'Fall deworming program' },
                    { cattleId: '#A-1247', date: '2024-10-15', activityType: 'weighing', details: 'Weight: 1,280 lbs', administeredBy: 'John Smith', notes: 'Monthly weight check, +15 lbs' },
                    { cattleId: '#A-1247', date: '2024-08-20', activityType: 'hoof-trim', details: 'Routine hoof maintenance', administeredBy: 'Mike Johnson', notes: 'All hooves in good condition' },

                    // Cow #H-2031 work history
                    { cattleId: '#H-2031', date: '2024-11-10', activityType: 'pregnancy-test', details: 'Confirmed pregnant - Due Jan 15', administeredBy: 'Dr. Sarah Williams', notes: 'Ultrasound shows healthy calf' },
                    { cattleId: '#H-2031', date: '2024-10-28', activityType: 'vaccination', details: 'Pre-breeding vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'No issues' },
                    { cattleId: '#H-2031', date: '2024-09-12', activityType: 'weighing', details: 'Weight: 1,340 lbs', administeredBy: 'John Smith', notes: 'Good body condition' },

                    // Cow #A-1893 work history
                    { cattleId: '#A-1893', date: '2024-11-01', activityType: 'vaccination', details: 'Cattle Master 4', administeredBy: 'Dr. Sarah Williams', notes: 'Annual booster' },
                    { cattleId: '#A-1893', date: '2024-09-20', activityType: 'treatment', details: 'Pink eye treatment - right eye', administeredBy: 'Dr. Sarah Williams', notes: 'Responding well to treatment' },

                    // Cow #CH-3012 work history
                    { cattleId: '#CH-3012', date: '2024-10-25', activityType: 'pregnancy-test', details: 'Confirmed pregnant - Due Feb 10', administeredBy: 'Dr. Sarah Williams', notes: 'Good prognosis' },

                    // Calf #A-1247-C5 work history
                    { cattleId: '#A-1247-C5', date: '2024-10-20', activityType: 'vaccination', details: 'First round - Bovi-Shield Gold 5', administeredBy: 'Dr. Sarah Williams', notes: 'Calf handled well' },
                    { cattleId: '#A-1247-C5', date: '2024-09-15', activityType: 'weighing', details: 'Weight: 325 lbs', administeredBy: 'John Smith', notes: 'Above average growth' },
                    { cattleId: '#A-1247-C5', date: '2024-08-10', activityType: 'deworming', details: 'Safe-Guard suspension', administeredBy: 'John Smith', notes: 'First deworming' },

                    // Calf #H-2031-C3 work history
                    { cattleId: '#H-2031-C3', date: '2024-10-12', activityType: 'vaccination', details: 'First vaccination - Bovi-Shield', administeredBy: 'Dr. Sarah Williams', notes: 'No issues' },
                    { cattleId: '#H-2031-C3', date: '2024-09-05', activityType: 'weighing', details: 'Weight: 298 lbs', administeredBy: 'John Smith', notes: 'Good weight gain' },

                    // Calf #A-1893-C6 work history
                    { cattleId: '#A-1893-C6', date: '2024-11-05', activityType: 'vaccination', details: 'Second round vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'Completed initial series' },
                    { cattleId: '#A-1893-C6', date: '2024-10-01', activityType: 'weighing', details: 'Weight: 380 lbs', administeredBy: 'John Smith', notes: 'Excellent growth rate' },
                    { cattleId: '#A-1893-C6', date: '2024-08-25', activityType: 'vaccination', details: 'First vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'Initial immunization' },

                    // Calf #CH-3012-C4 work history
                    { cattleId: '#CH-3012-C4', date: '2024-11-08', activityType: 'weighing', details: 'Weight: 445 lbs', administeredBy: 'John Smith', notes: 'Heavy calf - excellent genetics' },
                    { cattleId: '#CH-3012-C4', date: '2024-09-20', activityType: 'vaccination', details: 'Vaccination series', administeredBy: 'Dr. Sarah Williams', notes: 'Strong calf' },

                    // Cow #A-3012 work history
                    { cattleId: '#A-3012', date: '2024-11-02', activityType: 'vaccination', details: 'Cattle Master 4', administeredBy: 'Dr. Sarah Williams', notes: 'Annual vaccination, no reactions' },
                    { cattleId: '#A-3012', date: '2024-10-10', activityType: 'weighing', details: 'Weight: 1,195 lbs', administeredBy: 'John Smith', notes: 'Good body condition' },

                    // Calf #A-3012-C2 work history
                    { cattleId: '#A-3012-C2', date: '2024-10-18', activityType: 'vaccination', details: 'First vaccination - Bovi-Shield', administeredBy: 'Dr. Sarah Williams', notes: 'Calf handled well' },
                    { cattleId: '#A-3012-C2', date: '2024-09-22', activityType: 'weighing', details: 'Weight: 255 lbs', administeredBy: 'John Smith', notes: 'Good growth rate' },

                    // Additional cows work history
                    { cattleId: '#H-1556', date: '2024-11-01', activityType: 'vaccination', details: 'Cattle Master 4', administeredBy: 'Dr. Sarah Williams', notes: 'First-time mother doing well' },
                    { cattleId: '#R-2104', date: '2024-10-28', activityType: 'pregnancy-test', details: 'Confirmed pregnant - Due Feb 5', administeredBy: 'Dr. Sarah Williams', notes: 'Healthy pregnancy' },
                    { cattleId: '#A-2245', date: '2024-10-15', activityType: 'weighing', details: 'Weight: 1,395 lbs', administeredBy: 'John Smith', notes: 'Dry cow in good condition' },
                    { cattleId: '#A-2567', date: '2024-11-03', activityType: 'vaccination', details: 'Annual vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'No issues' },
                    { cattleId: '#R-3421', date: '2024-10-20', activityType: 'pregnancy-test', details: 'Confirmed pregnant - Due Jan 28', administeredBy: 'Dr. Sarah Williams', notes: 'Good condition' },
                    { cattleId: '#H-2891', date: '2024-11-05', activityType: 'vaccination', details: 'Cattle Master 4', administeredBy: 'Dr. Sarah Williams', notes: 'Routine vaccination' },
                    { cattleId: '#CH-1567', date: '2024-10-30', activityType: 'weighing', details: 'Weight: 1,480 lbs', administeredBy: 'John Smith', notes: 'Excellent weight' },
                    { cattleId: '#R-1945', date: '2024-11-08', activityType: 'vaccination', details: 'First vaccination for new calf', administeredBy: 'Dr. Sarah Williams', notes: 'Recent calving' },
                    { cattleId: '#H-3156', date: '2024-10-25', activityType: 'pregnancy-test', details: 'Confirmed pregnant - Due Feb 1', administeredBy: 'Dr. Sarah Williams', notes: 'Healthy' },
                    { cattleId: '#A-1678', date: '2024-11-02', activityType: 'vaccination', details: 'Cattle Master 4', administeredBy: 'Dr. Sarah Williams', notes: 'No reactions' },
                    { cattleId: '#CH-2345', date: '2024-10-18', activityType: 'weighing', details: 'Weight: 1,420 lbs', administeredBy: 'John Smith', notes: 'Good body score' },
                    { cattleId: '#R-2678', date: '2024-11-10', activityType: 'vaccination', details: 'Post-calving vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'Recent birth' },
                    { cattleId: '#H-1234', date: '2024-10-12', activityType: 'weighing', details: 'Weight: 1,370 lbs', administeredBy: 'John Smith', notes: 'Dry cow monitoring' },
                    { cattleId: '#A-2890', date: '2024-10-28', activityType: 'pregnancy-test', details: 'Confirmed pregnant - Due Jan 22', administeredBy: 'Dr. Sarah Williams', notes: 'Good prognosis' },
                    { cattleId: '#CH-1890', date: '2024-11-01', activityType: 'vaccination', details: 'Cattle Master 4', administeredBy: 'Dr. Sarah Williams', notes: 'Annual vaccination' },

                    // Additional calves work history
                    { cattleId: '#H-1556-C1', date: '2024-10-05', activityType: 'vaccination', details: 'First vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'First-time calf doing well' },
                    { cattleId: '#R-2104-C2', date: '2024-10-15', activityType: 'vaccination', details: 'Bovi-Shield vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'Healthy calf' },
                    { cattleId: '#A-2567-C3', date: '2024-10-20', activityType: 'weighing', details: 'Weight: 305 lbs', administeredBy: 'John Smith', notes: 'Good growth' },
                    { cattleId: '#R-3421-C4', date: '2024-10-10', activityType: 'vaccination', details: 'Vaccination series', administeredBy: 'Dr. Sarah Williams', notes: 'Healthy calf' },
                    { cattleId: '#H-2891-C5', date: '2024-10-25', activityType: 'weighing', details: 'Weight: 320 lbs', administeredBy: 'John Smith', notes: 'Excellent growth rate' },
                    { cattleId: '#CH-1567-C6', date: '2024-10-08', activityType: 'vaccination', details: 'Cattle vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'Strong calf' },
                    { cattleId: '#R-1945-C2', date: '2024-11-01', activityType: 'vaccination', details: 'First vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'Recent birth, doing well' },
                    { cattleId: '#H-3156-C4', date: '2024-10-18', activityType: 'weighing', details: 'Weight: 380 lbs', administeredBy: 'John Smith', notes: 'Good weight' },
                    { cattleId: '#A-1678-C5', date: '2024-10-22', activityType: 'vaccination', details: 'Vaccination series', administeredBy: 'Dr. Sarah Williams', notes: 'Healthy calf' },
                    { cattleId: '#CH-2345-C3', date: '2024-10-15', activityType: 'weighing', details: 'Weight: 395 lbs', administeredBy: 'John Smith', notes: 'Large calf, excellent genetics' },
                    { cattleId: '#R-2678-C1', date: '2024-11-05', activityType: 'vaccination', details: 'First vaccination', administeredBy: 'Dr. Sarah Williams', notes: 'New calf, healthy' },
                    { cattleId: '#A-2890-C4', date: '2024-10-28', activityType: 'weighing', details: 'Weight: 435 lbs', administeredBy: 'John Smith', notes: 'Heavy calf' },
                    { cattleId: '#CH-1890-C5', date: '2024-10-20', activityType: 'vaccination', details: 'Vaccination series', administeredBy: 'Dr. Sarah Williams', notes: 'Strong calf' }
                ];
                sampleWork.forEach(w => {
                    // Use combination of cattleId + date + activity as ID
                    const workData = { ...w, id: `${w.cattleId}-${w.date}-${w.activityType}` };
                    workStore.data.push(workData);
                });
                workStore.save();
            }
        }

        // Calculate age from date
        function calculateAge(birthDate) {
            if (!birthDate) return '‚Äî';
            const birth = new Date(birthDate);
            const now = new Date();
            const years = (now - birth) / (1000 * 60 * 60 * 24 * 365.25);
            return `${years.toFixed(1)} years`;
        }

        // State for sorting
        let currentSort = { field: null, direction: 'asc' };

        // View state (table or cards)
        let currentView = 'table';

        // Edit mode state
        let isEditMode = false;
        let draggedColumnIndex = null;
        let dragOverColumnIndex = null;

        // Column visibility state
        const defaultColumns = [
            { id: 'tagId', label: 'Tag ID', visible: true, locked: true },
            { id: 'breed', label: 'Breed', visible: true },
            { id: 'age', label: 'Age', visible: true },
            { id: 'weight', label: 'Weight', visible: true },
            { id: 'status', label: 'Status', visible: true },
            { id: 'totalCalves', label: 'Total Calves', visible: true },
            { id: 'lastCalving', label: 'Last Calving', visible: true },
            { id: 'currentCalf', label: 'Current Calf', visible: true },
            { id: 'actions', label: 'Actions', visible: true }
        ];

        // Load column preferences from session storage
        function loadColumnPreferences() {
            const saved = sessionStorage.getItem('cattle-columns');
            if (saved) {
                try {
                    const savedCols = JSON.parse(saved);
                    // Merge with defaults to handle any new columns
                    return defaultColumns.map(def => {
                        const saved = savedCols.find(s => s.id === def.id);
                        return saved ? { ...def, visible: saved.visible } : def;
                    });
                } catch (e) {
                    return [...defaultColumns];
                }
            }
            return [...defaultColumns];
        }

        let columns = loadColumnPreferences();

        // Save column preferences to session storage
        function saveColumnPreferences() {
            sessionStorage.setItem('cattle-columns', JSON.stringify(columns));
        }

        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const table = document.getElementById('cattle-table');
            const btn = document.getElementById('edit-columns-btn');
            const resetBtn = document.getElementById('reset-columns-btn');

            if (isEditMode) {
                table.classList.add('table-edit-mode');
                btn.innerHTML = '‚úì Done Editing<span class="edit-mode-badge">EDIT MODE</span>';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                resetBtn.style.display = 'inline-block';
            } else {
                table.classList.remove('table-edit-mode');
                btn.innerHTML = '‚öôÔ∏è Edit Columns';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                resetBtn.style.display = 'none';
            }

            renderTable();
        }

        // Reset columns to default
        function resetColumns() {
            // Reset to default columns configuration
            columns = defaultColumns.map(col => ({ ...col }));
            saveColumnPreferences();
            renderTable();
            Toast.success('Columns reset to default');
        }

        // Toggle column visibility
        function toggleColumnVisibility(columnId) {
            const column = columns.find(c => c.id === columnId);
            if (column && !column.locked) {
                column.visible = !column.visible;
                saveColumnPreferences();
                renderTable();
            }
        }

        // Reset columns to default
        function resetColumns() {
            columns = defaultColumns.map(c => ({ ...c, visible: true }));
            saveColumnPreferences();
            renderTable();
            Toast.success('Columns reset to default');
        }

        // Drag and drop handlers
        function handleDragStart(e, index) {
            draggedColumnIndex = index;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.currentTarget.innerHTML);
        }

        function handleDragOver(e, index) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            const th = e.currentTarget;

            // Remove drag-over from all columns
            document.querySelectorAll('th').forEach(header => {
                header.classList.remove('drag-over');
            });

            // Add drag-over to current column
            if (draggedColumnIndex !== index) {
                th.classList.add('drag-over');
                dragOverColumnIndex = index;
            }

            return false;
        }

        function handleDrop(e, index) {
            e.stopPropagation();
            e.preventDefault();

            if (draggedColumnIndex !== index && draggedColumnIndex !== null) {
                // Reorder columns array
                const draggedCol = columns[draggedColumnIndex];
                const newColumns = [...columns];

                // Remove from old position
                newColumns.splice(draggedColumnIndex, 1);

                // Insert at new position
                newColumns.splice(index, 0, draggedCol);

                columns = newColumns;
                saveColumnPreferences();
                renderTable();
            }

            return false;
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');

            // Remove all drag-over classes
            document.querySelectorAll('th').forEach(header => {
                header.classList.remove('drag-over');
            });

            draggedColumnIndex = null;
            dragOverColumnIndex = null;
        }

        // Apply filters and search
        function getFilteredCattle() {
            let cattle = cattleStore.getAll();

            // Apply search filter
            const searchTerm = document.getElementById('search-input')?.value.toLowerCase() || '';
            if (searchTerm) {
                cattle = cattle.filter(cow =>
                    cow.tagId.toLowerCase().includes(searchTerm) ||
                    cow.breed.toLowerCase().includes(searchTerm) ||
                    (cow.currentCalf && cow.currentCalf.toLowerCase().includes(searchTerm))
                );
            }

            // Apply status filter
            const statusFilter = document.getElementById('status-filter')?.value || '';
            if (statusFilter) {
                cattle = cattle.filter(cow => cow.status === statusFilter);
            }

            // Apply breed filter
            const breedFilter = document.getElementById('breed-filter')?.value || '';
            if (breedFilter) {
                cattle = cattle.filter(cow => cow.breed.includes(breedFilter));
            }

            // Apply age filter
            const ageFilter = document.getElementById('age-filter')?.value || '';
            if (ageFilter) {
                cattle = cattle.filter(cow => {
                    const ageYears = parseFloat(cow.age);
                    if (ageFilter === '0-2') return ageYears <= 2;
                    if (ageFilter === '2-5') return ageYears > 2 && ageYears <= 5;
                    if (ageFilter === '5+') return ageYears > 5;
                    return true;
                });
            }

            return cattle;
        }

        // Sort cattle array
        function sortCattle(cattle, field, direction) {
            return cattle.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                // Handle numeric fields
                if (field === 'weight' || field === 'totalCalves') {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                } else if (field === 'age') {
                    aVal = parseFloat(a.age) || 0;
                    bVal = parseFloat(b.age) || 0;
                } else if (field === 'lastCalving') {
                    aVal = aVal ? new Date(aVal).getTime() : 0;
                    bVal = bVal ? new Date(bVal).getTime() : 0;
                } else {
                    // String fields
                    aVal = (aVal || '').toString().toLowerCase();
                    bVal = (bVal || '').toString().toLowerCase();
                }

                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // Render table headers
        function renderTableHeaders() {
            const thead = document.getElementById('table-header');
            let html = '<th style="width: 40px;"></th>'; // Expand icon column

            const sortableFields = ['tagId', 'breed', 'age', 'weight', 'status', 'totalCalves', 'lastCalving'];

            columns.forEach((col, index) => {
                // In edit mode, show ALL columns (including hidden ones)
                // In normal mode, show only visible columns
                if (isEditMode || col.visible) {
                    const isSortable = sortableFields.includes(col.id);
                    const sortClass = isSortable ? 'sortable' : '';
                    const sortIcon = isSortable && !isEditMode ? '<span class="sort-icon">‚ñº</span>' : '';

                    // Drag attributes for edit mode
                    const draggable = isEditMode && !col.locked ? 'draggable="true"' : '';
                    const dragHandlers = isEditMode && !col.locked ?
                        `ondragstart="handleDragStart(event, ${index})"
                         ondragover="handleDragOver(event, ${index})"
                         ondrop="handleDrop(event, ${index})"
                         ondragend="handleDragEnd(event)"` : '';

                    // Checkbox in edit mode
                    const checkbox = isEditMode ? `
                        <div class="column-checkbox-wrapper">
                            <input
                                type="checkbox"
                                ${col.visible ? 'checked' : ''}
                                ${col.locked ? 'disabled' : ''}
                                onchange="toggleColumnVisibility('${col.id}')"
                                onclick="event.stopPropagation()"
                            >
                            <span class="column-checkbox-label">Show</span>
                        </div>
                    ` : '';

                    // Drag handle in edit mode (only for unlocked columns)
                    const dragHandle = isEditMode && !col.locked ? '<span class="drag-handle">‚ãÆ‚ãÆ</span>' : '';

                    html += `<th class="${sortClass}" ${draggable} ${dragHandlers} data-column-id="${col.id}">
                        ${dragHandle}
                        ${checkbox}
                        ${col.label} ${sortIcon}
                    </th>`;
                }
            });

            thead.innerHTML = html;
        }

        // Get cell content for a column
        function getCellContent(cow, columnId) {
            switch(columnId) {
                case 'tagId':
                    return `<span class="cow-id">${cow.tagId}</span>`;
                case 'breed':
                    return cow.breed;
                case 'age':
                    return cow.age;
                case 'weight':
                    return `${cow.weight} lbs`;
                case 'status':
                    return `<span class="status-badge status-${cow.status}">${cow.status}</span>`;
                case 'totalCalves':
                    return `<strong>${cow.totalCalves || 0}</strong>`;
                case 'lastCalving':
                    return cow.lastCalving || '‚Äî';
                case 'currentCalf':
                    return cow.currentCalf ? `<a href="#" class="action-link" onclick="event.stopPropagation(); expandToCalf('${cow.id}', '${cow.currentCalf}')">${cow.currentCalf}</a>` : '‚Äî';
                case 'actions':
                    return `<a href="#" class="action-link" onclick="event.stopPropagation(); editCow('${cow.id}')">Edit</a> | <a href="#" class="action-link" onclick="event.stopPropagation(); deleteCow('${cow.id}')">Delete</a>`;
                default:
                    return '‚Äî';
            }
        }

        // Render table
        function renderTable() {
            let cattle = getFilteredCattle();

            // Apply sorting if active
            if (currentSort.field) {
                cattle = sortCattle([...cattle], currentSort.field, currentSort.direction);
            }

            // Render headers
            renderTableHeaders();

            const tbody = document.getElementById('table-body');
            const totalCount = cattleStore.getAll().length;
            // In edit mode, count ALL columns. In normal mode, count only visible columns
            const visibleColCount = (isEditMode ? columns.length : columns.filter(c => c.visible).length) + 1; // +1 for expand icon
            document.getElementById('cow-count').textContent = totalCount;
            document.getElementById('pagination-info').textContent = `1-${cattle.length} of ${totalCount}`;

            if (cattle.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleColCount}" class="empty-state">No cattle match the selected filters.</td></tr>`;
                return;
            }

            let html = '';

            cattle.forEach(cow => {
                // Main row
                html += `<tr class="cow-row" data-cow-id="${cow.id}">`;
                html += `<td><span class="expand-icon">‚ñ∂</span></td>`;

                columns.forEach(col => {
                    // In edit mode, show ALL columns. In normal mode, show only visible columns
                    if (isEditMode || col.visible) {
                        html += `<td>${getCellContent(cow, col.id)}</td>`;
                    }
                });

                html += `</tr>`;

                // Expanded row
                html += `
                    <tr class="expanded-row" data-cow-id="${cow.id}">
                        <td colspan="${visibleColCount}" class="expanded-content">
                            <div class="expanded-inner">
                                ${renderExpandedContent(cow)}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            attachEventListeners();
        }

        // Render expanded content
        function renderExpandedContent(cow) {
            const calves = calfStore.search(cow.tagId, ['cattleId']);
            const work = workStore.search(cow.tagId, ['cattleId']);
            console.log(`Rendering ${cow.tagId}: ${calves.length} calves, ${work.length} work records`);

            return `
                <!-- Summary -->
                <div class="summary-grid">
                    <div class="summary-item">
                        <span class="summary-label">Purchase Date</span>
                        <span class="summary-value">${cow.purchaseDate || '‚Äî'}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Color/Markings</span>
                        <span class="summary-value">${cow.color || '‚Äî'}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Avg Weaning Wt</span>
                        <span class="summary-value highlight-metric">${cow.avgWeaningWeight || '‚Äî'} lbs</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Body Condition</span>
                        <span class="summary-value">${cow.bodyCondition || '‚Äî'}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Dam ID</span>
                        <span class="summary-value">${cow.damId || '‚Äî'}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Sire ID</span>
                        <span class="summary-value">${cow.sireId || '‚Äî'}</span>
                    </div>
                    ${cow.dueDate ? `
                        <div class="summary-item">
                            <span class="summary-label">Due Date</span>
                            <span class="summary-value highlight-metric">${cow.dueDate}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Days Pregnant</span>
                            <span class="summary-value highlight-metric">${cow.daysPregnant || '‚Äî'}</span>
                        </div>
                    ` : ''}
                </div>

                <!-- Tabs -->
                <div class="history-tabs">
                    <button class="history-tab active" data-tab="calves" data-cow="${cow.id}">üìä Calf History (${calves.length})</button>
                    <button class="history-tab" data-tab="work" data-cow="${cow.id}">üè• Work History (${work.length})</button>
                </div>

                <!-- Calf History -->
                <div class="tab-content active" data-tab="calves" data-cow="${cow.id}">
                    <button class="add-item-btn" onclick="event.stopPropagation(); showAddCalfModal('${cow.tagId}')">‚ûï Add Calf</button>
                    ${renderCalfTable(calves)}
                </div>

                <!-- Work History -->
                <div class="tab-content" data-tab="work" data-cow="${cow.id}">
                    <button class="add-item-btn" onclick="event.stopPropagation(); showAddWorkModal('${cow.tagId}')">‚ûï Add Work History</button>
                    ${renderWorkTable(work)}
                </div>
            `;
        }

        // Render calf table
        function renderCalfTable(calves) {
            if (calves.length === 0) return '<p class="empty-state">No calf history</p>';

            let html = '<table class="history-table calf-table"><thead><tr>' +
                '<th width="30"></th>' +
                '<th>Calf ID</th><th>Birth Date</th><th>Age</th><th>Gender</th>' +
                '<th>Birth Weight</th><th>Current/Weaning Weight</th><th>Weaning Age</th><th>Status</th>' +
                '</tr></thead><tbody>';

            calves.forEach(c => {
                const age = c.age || calculateAge(c.birthDate);
                const work = workStore.search(c.calfId, ['cattleId']);

                // Main calf row
                html += `
                    <tr class="calf-row" data-calf-id="${c.id}" onclick="toggleCalfExpand('${c.id}')">
                        <td><span class="expand-icon">‚ñ∂</span></td>
                        <td><strong>${c.calfId}</strong></td>
                        <td>${c.birthDate}</td>
                        <td>${age}</td>
                        <td><span class="gender-badge gender-${c.gender}">${c.gender}</span></td>
                        <td>${c.birthWeight} lbs</td>
                        <td>${c.currentWeight || c.weaningWeight || '‚Äî'} lbs${c.currentWeight ? ' (current)' : ''}</td>
                        <td>${c.weaningAge || '‚Äî'}</td>
                        <td><span class="status-badge status-${c.status}">${c.status}</span></td>
                    </tr>
                `;

                // Expanded work history row
                html += `
                    <tr class="calf-expanded-row" data-calf-id="${c.id}">
                        <td colspan="9" class="calf-expanded-content">
                            <div class="calf-work-section">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <strong>üè• Work History (${work.length})</strong>
                                    <button class="add-item-btn" onclick="event.stopPropagation(); showAddWorkModal('${c.calfId}')" style="margin: 0;">‚ûï Add Work History</button>
                                </div>
                                ${renderWorkTable(work)}
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        // Render work table
        function renderWorkTable(work) {
            if (work.length === 0) return '<p class="empty-state">No work history</p>';

            const icons = {
                vaccination: 'üíâ',
                deworming: 'üêõ',
                weighing: '‚öñÔ∏è',
                'hoof-trim': 'ü¶∂',
                'pregnancy-test': 'üî¨',
                treatment: 'üè•'
            };

            let html = '<table class="history-table"><thead><tr>' +
                '<th>Date</th><th>Activity Type</th><th>Details</th><th>Administered By</th><th>Notes</th>' +
                '</tr></thead><tbody>';

            work.forEach(w => {
                const icon = w.icon || icons[w.activityType] || 'üìù';
                html += `
                    <tr>
                        <td>${w.date}</td>
                        <td><span class="activity-type"><span class="activity-icon">${icon}</span>${w.activityType}</span></td>
                        <td>${w.details}</td>
                        <td>${w.administeredBy}</td>
                        <td>${w.notes || '‚Äî'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            return html;
        }

        // Render card view
        function renderCardView() {
            let cattle = getFilteredCattle();

            // Apply sorting if active
            if (currentSort.field) {
                cattle = sortCattle([...cattle], currentSort.field, currentSort.direction);
            }

            const cardGrid = document.getElementById('card-view');
            document.getElementById('cow-count').textContent = cattleStore.getAll().length;
            document.getElementById('pagination-info').textContent = `1-${cattle.length} of ${cattleStore.getAll().length}`;

            if (cattle.length === 0) {
                cardGrid.innerHTML = '<p class="empty-state" style="grid-column: 1/-1; text-align: center; padding: var(--space-6);">No cattle match the selected filters.</p>';
                return;
            }

            let html = '';
            cattle.forEach(cow => {
                html += renderCattleCard(cow);
            });

            cardGrid.innerHTML = html;
        }

        // Attach tab listeners for modal
        function attachTabListeners() {
            const modalBody = document.getElementById('detail-modal-body');

            // Tab switching
            modalBody.querySelectorAll('.history-tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tabName = this.dataset.tab;
                    const cowId = this.dataset.cow;

                    // Toggle active tab
                    modalBody.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
                    modalBody.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    this.classList.add('active');
                    const content = modalBody.querySelector(`.tab-content[data-tab="${tabName}"][data-cow="${cowId}"]`);
                    if (content) {
                        content.classList.add('active');
                    }
                });
            });

            // Attach calf expand listeners (scoped to modal)
            modalBody.querySelectorAll('.calf-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const calfId = this.dataset.calfId;

                    // Find elements within modal
                    const calfRow = modalBody.querySelector(`.calf-row[data-calf-id="${calfId}"]`);
                    const expandedRow = modalBody.querySelector(`.calf-expanded-row[data-calf-id="${calfId}"]`);
                    const isExpanded = calfRow.classList.contains('expanded');

                    // Collapse all other calves in modal
                    modalBody.querySelectorAll('.calf-row').forEach(r => r.classList.remove('expanded'));
                    modalBody.querySelectorAll('.calf-expanded-row').forEach(r => r.classList.remove('show'));

                    // Expand this calf if it wasn't already expanded
                    if (!isExpanded) {
                        calfRow.classList.add('expanded');
                        expandedRow.classList.add('show');
                    }
                });
            });
        }

        // Current cow ID for detail modal
        let currentDetailCowId = null;

        // Show cow detail modal (for card view)
        function showCowDetail(cowId) {
            const cow = cattleStore.getById(cowId);
            if (!cow) return;

            // Store current cow ID for edit/delete buttons
            currentDetailCowId = cowId;

            const modalTitle = document.getElementById('detail-modal-title');
            const modalBody = document.getElementById('detail-modal-body');

            modalTitle.textContent = `${cow.tagId} - ${cow.breed}`;
            modalBody.innerHTML = renderExpandedContent(cow);

            // Open modal
            ModalManager.show('detail-modal');

            // Re-attach tab listeners
            setTimeout(() => {
                attachTabListeners();
            }, 100);
        }

        // Edit cow from detail modal
        function editCowFromDetail() {
            if (currentDetailCowId) {
                closeModal('detail-modal');
                editCow(currentDetailCowId);
            }
        }

        // Delete cow from detail modal
        function deleteCowFromDetail() {
            if (currentDetailCowId) {
                closeModal('detail-modal');
                deleteCow(currentDetailCowId);
            }
        }

        // Render individual cattle card
        function renderCattleCard(cow) {
            const calves = calfStore.search(cow.tagId, ['cattleId']);
            const work = workStore.search(cow.tagId, ['cattleId']);

            return `
                <div class="cattle-card" onclick="showCowDetail('${cow.id}')">
                    <div class="card-header-section">
                        <h3 class="card-tag-id">${cow.tagId}</h3>
                        <span class="card-status-badge status-${cow.status}">${cow.status}</span>
                    </div>
                    <div class="card-body-section">
                        <div class="card-info-row">
                            <span class="card-label">Breed</span>
                            <span class="card-value">${cow.breed}</span>
                        </div>
                        <div class="card-info-row">
                            <span class="card-label">Age</span>
                            <span class="card-value">${cow.age}</span>
                        </div>
                        <div class="card-info-row">
                            <span class="card-label">Weight</span>
                            <span class="card-value">${cow.weight} lbs</span>
                        </div>
                        <div class="card-info-row">
                            <span class="card-label">Total Calves</span>
                            <span class="card-value"><strong>${cow.totalCalves || 0}</strong></span>
                        </div>
                        <div class="card-info-row">
                            <span class="card-label">Last Calving</span>
                            <span class="card-value">${cow.lastCalving || '‚Äî'}</span>
                        </div>
                        ${cow.currentCalf ? `
                            <div class="card-info-row">
                                <span class="card-label">Current Calf</span>
                                <span class="card-value"><a href="#" class="action-link" onclick="event.stopPropagation(); showCowDetail('${cow.id}')">${cow.currentCalf}</a></span>
                            </div>
                        ` : ''}
                        ${cow.dueDate ? `
                            <div class="card-info-row card-highlight">
                                <span class="card-label">Due Date</span>
                                <span class="card-value"><strong>${cow.dueDate}</strong></span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Switch between table and card view
        function switchView(view) {
            currentView = view;
            const tableView = document.getElementById('table-view');
            const cardGrid = document.getElementById('card-view');
            const tableViewBtn = document.getElementById('table-view-btn');
            const cardViewBtn = document.getElementById('card-view-btn');

            if (view === 'cards') {
                tableView.style.display = 'none';
                cardGrid.classList.add('active');
                tableViewBtn.classList.remove('btn-primary');
                tableViewBtn.classList.add('btn-secondary');
                cardViewBtn.classList.remove('btn-secondary');
                cardViewBtn.classList.add('btn-primary');
                renderCardView();
            } else {
                tableView.style.display = 'block';
                cardGrid.classList.remove('active');
                cardViewBtn.classList.remove('btn-primary');
                cardViewBtn.classList.add('btn-secondary');
                tableViewBtn.classList.remove('btn-secondary');
                tableViewBtn.classList.add('btn-primary');
                renderTable();
            }
        }

        // Toggle calf expansion
        function toggleCalfExpand(calfId) {
            const calfRow = document.querySelector(`.calf-row[data-calf-id="${calfId}"]`);
            const expandedRow = document.querySelector(`.calf-expanded-row[data-calf-id="${calfId}"]`);
            const isExpanded = calfRow.classList.contains('expanded');

            // Collapse all other calves
            document.querySelectorAll('.calf-row').forEach(r => r.classList.remove('expanded'));
            document.querySelectorAll('.calf-expanded-row').forEach(r => r.classList.remove('show'));

            // Expand this calf if it wasn't already expanded
            if (!isExpanded) {
                calfRow.classList.add('expanded');
                expandedRow.classList.add('show');
            }
        }

        // Expand cow and navigate to specific calf
        function expandToCalf(cowId, calfTagId) {
            // First, expand the cow row
            const cowRow = document.querySelector(`.cow-row[data-cow-id="${cowId}"]`);
            const cowExpandedRow = document.querySelector(`.expanded-row[data-cow-id="${cowId}"]`);

            if (!cowRow || !cowExpandedRow) return;

            // Collapse all other cows
            document.querySelectorAll('.cow-row').forEach(r => r.classList.remove('expanded'));
            document.querySelectorAll('.expanded-row').forEach(r => r.classList.remove('show'));

            // Expand this cow
            cowRow.classList.add('expanded');
            cowExpandedRow.classList.add('show');

            // Switch to Calves tab and expand the specific calf
            setTimeout(() => {
                // Activate Calves tab
                const calvesTab = cowExpandedRow.querySelector('.history-tab[data-tab="calves"]');
                const calvesContent = cowExpandedRow.querySelector('.tab-content[data-tab="calves"]');

                if (calvesTab && calvesContent) {
                    cowExpandedRow.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
                    cowExpandedRow.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    calvesTab.classList.add('active');
                    calvesContent.classList.add('active');

                    // Find the calf by tag ID and expand it
                    setTimeout(() => {
                        const calves = calfStore.getAll().filter(c => c.cattleId === cattleStore.getById(cowId).tagId);
                        const targetCalf = calves.find(c => c.calfId === calfTagId);

                        if (targetCalf) {
                            const calfRow = cowExpandedRow.querySelector(`.calf-row[data-calf-id="${targetCalf.id}"]`);
                            const calfExpandedRow = cowExpandedRow.querySelector(`.calf-expanded-row[data-calf-id="${targetCalf.id}"]`);

                            if (calfRow && calfExpandedRow) {
                                // Collapse all other calves
                                cowExpandedRow.querySelectorAll('.calf-row').forEach(r => r.classList.remove('expanded'));
                                cowExpandedRow.querySelectorAll('.calf-expanded-row').forEach(r => r.classList.remove('show'));

                                // Expand this calf
                                calfRow.classList.add('expanded');
                                calfExpandedRow.classList.add('show');

                                // Scroll to the calf
                                calfRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        }
                    }, 100);
                }
            }, 100);
        }

        // Attach event listeners
        function attachEventListeners() {
            // Row expansion
            document.querySelectorAll('.cow-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    if (e.target.classList.contains('action-link')) {
                        e.preventDefault();
                        return;
                    }

                    const cowId = this.dataset.cowId;
                    const expandedRow = document.querySelector(`.expanded-row[data-cow-id="${cowId}"]`);
                    const isExpanded = this.classList.contains('expanded');

                    document.querySelectorAll('.cow-row').forEach(r => r.classList.remove('expanded'));
                    document.querySelectorAll('.expanded-row').forEach(r => r.classList.remove('show'));

                    if (!isExpanded) {
                        this.classList.add('expanded');
                        expandedRow.classList.add('show');
                    }
                });
            });

            // Tab switching
            document.querySelectorAll('.history-tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tabName = this.dataset.tab;
                    const cowId = this.dataset.cow;
                    const expandedRow = this.closest('.expanded-inner');

                    expandedRow.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    expandedRow.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        if (content.dataset.tab === tabName && content.dataset.cow === cowId) {
                            content.classList.add('active');
                        }
                    });
                });
            });
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.getElementById('modal-backdrop').classList.add('show');
        }

        function closeModal(modalId) {
            ModalManager.hide(modalId);
        }

        // Confirmation modal
        function showConfirmation(message, callback) {
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;

            // Set up the confirm button click handler
            document.getElementById('confirm-btn').onclick = () => {
                if (confirmCallback) {
                    confirmCallback();
                    confirmCallback = null;
                }
                closeModal('confirm-modal');
            };

            showModal('confirm-modal');
        }

        // Add Cow Modal
        function showAddCowModal() {
            document.getElementById('cow-modal-title').textContent = 'Add New Cow';
            document.getElementById('cow-id').value = '';
            document.getElementById('cow-form').reset();
            showModal('cow-modal');
        }

        // Edit Cow
        function editCow(id) {
            const cow = cattleStore.getById(id);
            if (!cow) {
                console.error('Cow not found with ID:', id);
                return;
            }

            console.log('Editing cow:', id, cow);
            document.getElementById('cow-modal-title').textContent = 'Edit Cow';
            document.getElementById('cow-id').value = id;
            document.getElementById('cow-tagId').value = cow.tagId;
            document.getElementById('cow-breed').value = cow.breed;
            document.getElementById('cow-age').value = cow.age;
            document.getElementById('cow-weight').value = cow.weight;
            document.getElementById('cow-status').value = cow.status;
            document.getElementById('cow-purchaseDate').value = cow.purchaseDate || '';
            document.getElementById('cow-color').value = cow.color || '';
            document.getElementById('cow-bodyCondition').value = cow.bodyCondition || '';
            document.getElementById('cow-avgWeaningWeight').value = cow.avgWeaningWeight || '';
            document.getElementById('cow-damId').value = cow.damId || '';
            document.getElementById('cow-sireId').value = cow.sireId || '';

            console.log('Hidden ID field set to:', document.getElementById('cow-id').value);
            showModal('cow-modal');
        }

        // Save Cow
        function saveCow(e) {
            e.preventDefault();

            const id = document.getElementById('cow-id').value;
            console.log('Saving cow with ID:', id);

            const data = {
                tagId: document.getElementById('cow-tagId').value,
                breed: document.getElementById('cow-breed').value,
                age: document.getElementById('cow-age').value,
                weight: parseInt(document.getElementById('cow-weight').value),
                status: document.getElementById('cow-status').value,
                purchaseDate: document.getElementById('cow-purchaseDate').value,
                color: document.getElementById('cow-color').value,
                bodyCondition: document.getElementById('cow-bodyCondition').value,
                avgWeaningWeight: parseInt(document.getElementById('cow-avgWeaningWeight').value) || null,
                damId: document.getElementById('cow-damId').value,
                sireId: document.getElementById('cow-sireId').value,
                totalCalves: 0,
                lastCalving: null,
                currentCalf: null
            };

            console.log('Data to save:', data);

            if (id) {
                const existing = cattleStore.getById(id);
                console.log('Updating existing cow:', existing);
                data.totalCalves = existing.totalCalves;
                data.lastCalving = existing.lastCalving;
                data.currentCalf = existing.currentCalf;
                const result = cattleStore.update(id, data);
                console.log('Update result:', result);
                Toast.success('Cow updated successfully');
            } else {
                const result = cattleStore.add(data);
                console.log('Add result:', result);
                Toast.success('Cow added successfully');
            }

            closeModal('cow-modal');
            renderCurrentView();
        }

        // Delete Cow
        function deleteCow(id) {
            showConfirmation('Are you sure you want to delete this cow? This will also delete all associated calf and work history.', () => {
                const cow = cattleStore.getById(id);

                // Delete associated calves and work history
                calfStore.getAll().filter(c => c.cattleId === cow.tagId).forEach(c => calfStore.delete(c.id));
                workStore.getAll().filter(w => w.cattleId === cow.tagId).forEach(w => workStore.delete(w.id));

                cattleStore.delete(id);
                Toast.success('Cow deleted successfully');
                renderTable();
            });
        }

        // Add Calf Modal
        function showAddCalfModal(cattleId) {
            document.getElementById('calf-parentId').value = cattleId;
            document.getElementById('calf-form').reset();

            // Auto-generate calf ID
            const parent = cattleStore.search(cattleId, ['tagId'])[0];
            if (parent) {
                const calfCount = calfStore.search(cattleId, ['cattleId']).length + 1;
                document.getElementById('calf-calfId').value = `${cattleId}-C${calfCount}`;
            }

            showModal('calf-modal');
        }

        // Save Calf
        function saveCalf(e) {
            e.preventDefault();

            const data = {
                cattleId: document.getElementById('calf-parentId').value,
                calfId: document.getElementById('calf-calfId').value,
                birthDate: document.getElementById('calf-birthDate').value,
                gender: document.getElementById('calf-gender').value,
                birthWeight: parseInt(document.getElementById('calf-birthWeight').value),
                currentWeight: parseInt(document.getElementById('calf-currentWeight').value) || null,
                status: document.getElementById('calf-status').value,
                weaningWeight: parseInt(document.getElementById('calf-weaningWeight').value) || null,
                weaningAge: document.getElementById('calf-weaningAge').value || null,
                age: calculateAge(document.getElementById('calf-birthDate').value)
            };

            calfStore.add(data);

            // Update parent cow
            const parent = cattleStore.search(data.cattleId, ['tagId'])[0];
            if (parent) {
                // Store parent ID to re-expand after render
                const parentCowId = parent.id;

                cattleStore.update(parent.id, {
                    totalCalves: (parent.totalCalves || 0) + 1,
                    lastCalving: data.birthDate,
                    currentCalf: data.calfId
                });

                Toast.success('Calf added successfully');
                closeModal('calf-modal');

                // Re-render current view (table or cards)
                renderCurrentView();

                // Re-expand the parent cow row (only in table view)
                if (currentView === 'table') {
                    setTimeout(() => {
                        const cowRow = document.querySelector(`.cow-row[data-cow-id="${parentCowId}"]`);
                        const expandedRow = document.querySelector(`.expanded-row[data-cow-id="${parentCowId}"]`);
                        if (cowRow && expandedRow) {
                            cowRow.classList.add('expanded');
                            expandedRow.classList.add('show');
                        }
                    }, 0);
                }
            } else {
                Toast.success('Calf added successfully');
                closeModal('calf-modal');
                renderCurrentView();
            }
        }

        // Add Work History Modal
        function showAddWorkModal(cattleId) {
            document.getElementById('work-cattleId').value = cattleId;
            document.getElementById('work-form').reset();
            document.getElementById('work-date').valueAsDate = new Date();
            showModal('work-modal');
        }

        // Save Work History
        function saveWork(e) {
            e.preventDefault();

            const activityType = document.getElementById('work-activityType').value;
            const icons = {
                vaccination: 'üíâ',
                deworming: 'üêõ',
                weighing: '‚öñÔ∏è',
                'hoof-trim': 'ü¶∂',
                'pregnancy-test': 'üî¨',
                treatment: 'üè•'
            };

            const data = {
                cattleId: document.getElementById('work-cattleId').value,
                date: document.getElementById('work-date').value,
                activityType: activityType,
                icon: icons[activityType],
                details: document.getElementById('work-details').value,
                administeredBy: document.getElementById('work-administeredBy').value,
                notes: document.getElementById('work-notes').value
            };

            workStore.add(data);

            // Determine if this is for a cow or a calf
            const cattleId = data.cattleId;
            const isCalfId = cattleId.includes('-C'); // Calf IDs have '-C' in them
            let parentCowId = null;
            let calfId = null;

            if (isCalfId) {
                // This is a calf - find the parent cow
                const calf = calfStore.search(cattleId, ['calfId'])[0];
                if (calf) {
                    const parentCow = cattleStore.search(calf.cattleId, ['tagId'])[0];
                    if (parentCow) {
                        parentCowId = parentCow.id;
                        calfId = calf.id;
                    }
                }
            } else {
                // This is a cow
                const cow = cattleStore.search(cattleId, ['tagId'])[0];
                if (cow) {
                    parentCowId = cow.id;
                }
            }

            Toast.success('Work history added successfully');
            closeModal('work-modal');
            renderCurrentView();

            // Re-expand the parent cow row if found (only in table view)
            if (parentCowId && currentView === 'table') {
                setTimeout(() => {
                    const cowRow = document.querySelector(`.cow-row[data-cow-id="${parentCowId}"]`);
                    const expandedRow = document.querySelector(`.expanded-row[data-cow-id="${parentCowId}"]`);
                    if (cowRow && expandedRow) {
                        cowRow.classList.add('expanded');
                        expandedRow.classList.add('show');

                        if (isCalfId && calfId) {
                            // Added to calf - expand calf row and stay on Calves tab
                            const calfRow = expandedRow.querySelector(`.calf-row[data-calf-id="${calfId}"]`);
                            const calfExpandedRow = expandedRow.querySelector(`.calf-expanded-row[data-calf-id="${calfId}"]`);

                            if (calfRow && calfExpandedRow) {
                                calfRow.classList.add('expanded');
                                calfExpandedRow.classList.add('show');
                            }

                            // Make sure Calves tab is active
                            const calvesTab = expandedRow.querySelector('.history-tab[data-tab="calves"]');
                            const calvesContent = expandedRow.querySelector('.tab-content[data-tab="calves"]');
                            if (calvesTab && calvesContent) {
                                expandedRow.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
                                expandedRow.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                                calvesTab.classList.add('active');
                                calvesContent.classList.add('active');
                            }
                        } else {
                            // Added to cow - switch to Work History tab
                            const workTab = expandedRow.querySelector('.history-tab[data-tab="work"]');
                            const workContent = expandedRow.querySelector('.tab-content[data-tab="work"]');
                            if (workTab && workContent) {
                                expandedRow.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
                                expandedRow.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                                workTab.classList.add('active');
                                workContent.classList.add('active');
                            }
                        }
                    }
                }, 0);
            }
        }

        // Reset search and filters
        function resetFilters() {
            // Clear search input
            document.getElementById('search-input').value = '';

            // Reset all filter selects
            document.getElementById('status-filter').value = '';
            document.getElementById('breed-filter').value = '';
            document.getElementById('age-filter').value = '';

            // Re-render table
            renderTable();
        }

        // Handle column sort
        function handleColumnSort(field) {
            // Toggle direction if clicking same field
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }

            // Update sort icons
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.textContent = '‚ñº';
            });

            // Get the column header and update its sort icon
            const fieldMap = {
                'tagId': 0,
                'breed': 1,
                'age': 2,
                'weight': 3,
                'status': 4,
                'totalCalves': 5,
                'lastCalving': 6
            };
            const colIndex = fieldMap[field];
            if (colIndex !== undefined) {
                const sortableHeaders = document.querySelectorAll('.sortable');
                const header = sortableHeaders[colIndex];
                if (header) {
                    header.classList.add('sorted');
                    const icon = header.querySelector('.sort-icon');
                    if (icon) {
                        icon.textContent = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
                    }
                }
            }

            renderTable();
        }

        // Initialize
        // Render the current view (table or cards)
        function renderCurrentView() {
            if (currentView === 'cards') {
                renderCardView();
            } else {
                renderTable();
            }
        }

        // Detect mobile and initialize appropriate view
        function initializeView() {
            // Mobile detection disabled - always start with table view
            // const isMobile = window.innerWidth <= 768;
            // if (isMobile) {
            //     switchView('cards');
            // } else {
                renderTable();
            // }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initSampleData();
            initializeView();

            // Add search/filter event listeners
            document.getElementById('search-input').addEventListener('input', renderCurrentView);
            document.getElementById('status-filter').addEventListener('change', renderCurrentView);
            document.getElementById('breed-filter').addEventListener('change', renderCurrentView);
            document.getElementById('age-filter').addEventListener('change', renderCurrentView);

            // Add column sort event listeners (delegate to table header)
            document.getElementById('table-header').addEventListener('click', (e) => {
                const th = e.target.closest('th.sortable');
                if (th) {
                    const headerText = th.textContent.trim().replace(/[‚ñº‚ñ≤]/g, '').trim();
                    const column = columns.find(c => c.label === headerText);
                    if (column) {
                        handleColumnSort(column.id);
                    }
                }
            });

            // Handle window resize for orientation changes (DISABLED)
            // let resizeTimer;
            // window.addEventListener('resize', () => {
            //     clearTimeout(resizeTimer);
            //     resizeTimer = setTimeout(() => {
            //         const isMobile = window.innerWidth <= 768;
            //         const isCurrentlyCards = currentView === 'cards';

            //         // Auto-switch based on screen size
            //         if (isMobile && !isCurrentlyCards) {
            //             switchView('cards');
            //         } else if (!isMobile && isCurrentlyCards && window.innerWidth > 768) {
            //             // Only switch back to table on desktop if user didn't manually choose cards
            //             // For now, keep user's choice
            //         }
            //     }, 250);
            // });
        });
    </script>
</body>
</html>
